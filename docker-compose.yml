version: '3.8'

services:
  # Main pipeline service
  3dtrees:
    build:
      context: .
      dockerfile: Dockerfile
    image: 3dtrees-smart-tile:latest
    container_name: 3dtrees_smart_tile

    # Mount data volumes
    volumes:
      - ${DATA_PATH:-./data}:/data

    # Default command: show help
    # Override with: docker-compose run 3dtrees --task tile ...
    command: [ "--help" ]

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 16G
        reservations:
          memory: 4G

  # Tile task
  tile:
    build:
      context: .
      dockerfile: Dockerfile
    image: 3dtrees-smart-tile:latest

    volumes:
      - ${DATA_PATH:-./data}:/data

    command: [ "--task", "tile", "--input_dir", "/data/input", "--output_dir", "/data/output", "--tile_length", "${TILE_LENGTH:-100}", "--tile_buffer", "${TILE_BUFFER:-5}", "--workers", "${WORKERS:-4}" ]

    deploy:
      resources:
        limits:
          memory: 16G

  # Merge task
  merge:
    build:
      context: .
      dockerfile: Dockerfile
    image: 3dtrees-smart-tile:latest

    volumes:
      - ${DATA_PATH:-./data}:/data

    command: [ "--task", "merge", "--subsampled_10cm_folder", "/data/output/tiles_${TILE_LENGTH:-100}m/subsampled_10cm", "--workers", "${WORKERS:-4}" ]

    deploy:
      resources:
        limits:
          memory: 16G

  # Interactive development shell
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: 3dtrees-smart-tile:latest
    container_name: 3dtrees_dev
    stdin_open: true
    tty: true
    entrypoint: /bin/bash

    volumes:
      - ${DATA_PATH:-./data}:/data
      # Mount source for development
      - ./src:/src:ro

    environment:
      - PYTHONPATH=/src

# Usage:
# ------
# Build:
#   docker-compose build
#
# Tile task:
#   DATA_PATH=/path/to/data docker-compose run tile
#
# Merge task:
#   DATA_PATH=/path/to/data docker-compose run merge
#
# Interactive shell:
#   DATA_PATH=/path/to/data docker-compose run dev
#
# Custom parameters:
#   DATA_PATH=/path/to/data TILE_LENGTH=150 docker-compose run tile
